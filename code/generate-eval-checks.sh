#!/usr/bin/env nix-shell
#!nix-shell -i bash -p git nix jq
#!nix-shell --pure

set -e

REPO_ROOT=$(git rev-parse --show-toplevel)

mkdir -p "${REPO_ROOT}/.woodpecker"

echo "Generate matrix"
nix eval --json "${REPO_ROOT}#githubActions.matrix" > "${REPO_ROOT}/.woodpecker/matrix.json"

echo "Creating eval-checks.yml..."
cat > "${REPO_ROOT}/.woodpecker/eval-checks.yml" << EOF
# This file is generated by code/generate-eval-checks.sh
# Do not edit it manually
steps:
  evaluate:
    image: nixos/nix:latest
    environment:
      NIX_CONFIG: "experimental-features = nix-command flakes"
    commands:
      - echo "Evaluating \${ATTR}"
      - nix eval -v '.#\${ATTR}'

matrix:
  include:

EOF

echo "Adding Matrix attributes..."
cat "${REPO_ROOT}/.woodpecker/matrix.json" | \
  jq -r '.include[] | .attr | select(contains("formatting") | not)' | \
  sed 's/^githubActions\.//' | \
  sed 's/^/    - ATTR: /' >> "${REPO_ROOT}/.woodpecker/eval-checks.yml"

cat >> "${REPO_ROOT}/.woodpecker/eval-checks.yml" << EOF

depends_on:
  - formatting-check

when:
  event:
    - pull_request
    - push
EOF

rm "${REPO_ROOT}/.woodpecker/matrix.json"
echo "âœ… eval-checks.yml updated"
cat "${REPO_ROOT}/.woodpecker/eval-checks.yml"
