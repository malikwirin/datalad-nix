#!/usr/bin/env nix-shell
#!nix-shell -i bash -p git nix
#!nix-shell --pure

set -e

REPO_ROOT=$(git rev-parse --show-toplevel)

mkdir -p "${REPO_ROOT}/.woodpecker"

echo "Creating formatting-check.yml..."
cat > "${REPO_ROOT}/.woodpecker/formatting-check.yml" << EOF
# This file is generated by code/generate-formatter-check.sh
# Do not edit it manually
steps:
  formatting-check:
    image: nixos/nix:latest
    environment:
      NIX_CONFIG: "experimental-features = nix-command flakes"
    commands:
      - |
        NIX_ARCH=\$(nix eval --raw --expr 'builtins.currentSystem')
        echo "Current system platform: \${NIX_ARCH}"

        echo "Running formatting check for \${NIX_ARCH}..."
        nix build -L .#checks.\${NIX_ARCH}."formatting"

when:
  event:
    - pull_request
    - push
EOF

echo "âœ… formatting-check.yml updated"
cat "${REPO_ROOT}/.woodpecker/formatting-check.yml"
